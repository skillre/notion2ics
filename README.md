# Notion到日历同步工具 (Notion2ICS)

这个项目可以将Notion数据库中的日程安排自动转换为iCalendar (.ics)格式，并提供一个可以订阅的在线日历链接。通过这个链接，您可以在macOS、iOS和其他支持iCalendar订阅的设备上同步您的Notion日程安排。

## 功能特点

- 实时从Notion数据库获取日程安排
- 将Notion事件转换为标准iCalendar格式
- 提供可订阅的日历链接
- 实时响应，每次日历应用请求时都获取最新数据
- 适配全天事件和定时事件
- 包含事件标题、描述、位置等信息
- 支持自定义Notion字段映射，适应不同的数据库结构
- **基于令牌的访问控制，保护您的日历数据安全**

## 必要条件

在部署此项目前，您需要：

1. 一个[Notion](https://www.notion.so)账户和包含日程安排的数据库
2. [Notion API密钥](https://www.notion.so/my-integrations)
3. 一个Vercel账户（用于部署）

## Notion数据库要求

您的Notion数据库需要包含日期信息，默认会查找以下属性（所有属性名称均可通过环境变量自定义）：

- `Name`: 标题类型，用作事件标题
- `Date`: 日期类型，包含事件的开始和结束时间
- `Description`: 富文本类型（可选），用作事件描述
- `Location`: 富文本类型（可选），用作事件地点

## 部署步骤

### 1. Fork或Clone此仓库

首先，将此仓库Fork到您的GitHub账户，或直接克隆到本地。

### 2. 获取Notion API密钥和数据库ID

1. 访问[Notion Integrations](https://www.notion.so/my-integrations)创建一个新的集成
2. 为集成授予适当的权限（至少需要读取数据库的权限）
3. 复制生成的API密钥
4. 在您的Notion数据库页面，点击"分享"并将您刚创建的集成添加为成员
5. 从数据库URL中获取数据库ID（格式为：https://www.notion.so/workspace/[数据库ID]?v=...)

### 3. 设置访问令牌

为了保护您的日历数据安全，您需要设置一个访问令牌：

1. 生成一个强密码作为访问令牌（推荐使用随机字符串生成器）
2. 将该令牌保存在安全的地方，例如密码管理器

### 4. 部署到Vercel

1. 登录[Vercel](https://vercel.com)
2. 点击"New Project"并从GitHub导入您的仓库
3. 在环境变量设置中添加以下变量：
   - `NOTION_API_KEY`: 您的Notion API密钥
   - `NOTION_DATABASE_ID`: 您的Notion数据库ID
   - `ACCESS_TOKEN`: 您的访问令牌，用于保护日历数据
   - 可选：根据您的数据库结构配置自定义字段映射（见下文）
4. 点击"Deploy"开始部署

### 5. 在您的设备上订阅日历

1. 访问部署好的应用首页
2. 输入您设置的访问令牌，点击"生成安全链接"
3. 复制生成的链接（包含访问令牌）
4. 在设备的日历应用中订阅该链接

#### 在macOS上：

1. 打开"日历"应用
2. 点击菜单栏中的"文件" > "新建日历订阅"
3. 粘贴带有访问令牌的日历链接
4. 设置自动更新频率（推荐设置为"每小时"）

#### 在iOS上：

1. 前往"设置" > "日历" > "账户"
2. 点击"添加账户" > "其他"
3. 选择"添加已订阅的日历"
4. 粘贴带有访问令牌的日历链接
5. 您可以在"设置" > "日历" > "账户" > "获取新数据"中设置刷新频率

## 自定义字段映射

如果您的Notion数据库使用了与默认不同的属性名称，可以通过设置以下环境变量来自定义字段映射：

| 环境变量 | 默认值 | 说明 |
|---------|-------|-----|
| NOTION_TITLE_FIELD | Name | 事件标题字段（标题类型）|
| NOTION_DATE_FIELD | Date | 事件日期字段（日期类型）|
| NOTION_DESCRIPTION_FIELD | Description | 事件描述字段（富文本类型）|
| NOTION_LOCATION_FIELD | Location | 事件地点字段（富文本类型）|
| NOTION_SORT_FIELD | 同日期字段 | 结果排序字段 |
| NOTION_SORT_DIRECTION | ascending | 排序方向（ascending或descending）|

## 安全措施

本项目包含以下安全措施来保护您的日历数据：

1. **基于令牌的访问控制**：只有知道正确访问令牌的用户才能访问日历数据
2. **安全令牌比较**：使用恒定时间比较防止计时攻击
3. **错误提示不泄露敏感信息**：系统错误消息经过处理，避免泄露服务器信息
4. **本地存储令牌**：浏览器本地存储访问令牌，避免重复输入

### 访问令牌设置建议

- 使用随机生成的强密码（至少16个字符）
- 包含字母、数字和特殊字符
- 定期更换访问令牌以提高安全性
- 如果发现令牌泄露，立即在Vercel的项目设置中更换 ACCESS_TOKEN 环境变量

## 本地开发

如果您想在本地开发和测试此项目：

1. 克隆仓库到本地
2. 安装依赖： `npm install`
3. 创建`.env.local`文件并添加必要的环境变量
   ```
   NOTION_API_KEY=your_notion_api_key_here
   NOTION_DATABASE_ID=your_notion_database_id_here
   ACCESS_TOKEN=your_secure_access_token
   # 可选：自定义字段映射
   NOTION_TITLE_FIELD=自定义标题字段
   NOTION_DATE_FIELD=自定义日期字段
   ```
4. 启动开发服务器： `npm run dev`
5. 访问 `http://localhost:3000` 查看应用

## 工作原理

本项目采用"实时获取"机制，与传统的定时同步不同：

- 每次日历应用请求ICS文件时，服务器都会直接从Notion获取最新数据
- 系统获取从2023年1月1日开始到当前日期后2个月内的所有工作安排
- 实现了智能分页加载，每次最多获取90条记录，避免达到API限制
- 内置请求频率控制和错误重试机制，确保数据完整性
- 所有时间均转换为北京时间(UTC+8)显示
- 通过访问令牌验证用户身份，确保数据安全
- 日历更新频率取决于您在日历应用中设置的刷新频率

## 注意事项

- 请妥善保管您的访问令牌，不要泄露给未授权的人员
- 频繁的日历刷新可能会导致更多的API调用
- Notion API有速率限制，请根据您的需求适当设置日历的刷新频率
- 确保您的Notion集成已被授权访问您的数据库
- 如果修改了字段映射，确保对应的字段类型正确，否则可能导致数据无法正确转换

## 许可

此项目采用MIT许可证。

## 作者

[skillre]

## ☕️☕️

觉得有帮助，可以奖励作者一杯☕️，持续做出好用的工具。

![](https://skillre-typora.oss-cn-beijing.aliyuncs.com/img/paycode.jpeg)

---

希望这个工具能帮助您更好地管理日程安排！如果有任何问题或建议，请通过GitHub Issues联系我。 